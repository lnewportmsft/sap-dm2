{
	"name": "CostCenterHierarchy_View",
	"properties": {
		"content": {
			"query": "\nCREATE VIEW [sap_master].[COSTCENTERHIERARCHY] AS\nWITH FHN (\n\t[COSTCENTERHIERARCHY]\n\t,[PARENTNODE]\n\t,[HIERARCHYNODE]\n\t,[Controllingarea]\n\t,[HIERARCHYNODEVAL]\n\t,[Nodetype]\n    ,[Key]\n\t)\nAS (\n\tSELECT H.[COSTCENTERHIERARCHY]\n\t\t,H.[PARENTNODE]\n\t\t,H.[HIERARCHYNODE]\n\t\t,H.[Controllingarea]\n\t\t,H.[HIERARCHYNODEVAL]\n\t\t,H.[Nodetype]\n        ,H.[Key]\n\tFROM [sap_master].[I_COSTCENTERHIERARCHYNODE] H\n\tWHERE H.[VALIDITYENDDATE] = '99991231'\n\tGROUP BY H.[COSTcenterHIERARCHY]\n\t\t,H.[PARENTNODE]\n\t\t,H.[HIERARCHYNODE]\n\t\t,H.[Controllingarea]\n\t\t,H.[HIERARCHYNODEVAL]\n\t\t,H.[Nodetype]\n        ,H.[Key]\n\t) (\n\t\tSELECT L1.[COSTcenterHIERARCHY]\n\t\t\t,L1.[Controllingarea]\n\t\t\t,(\n\t\t\t\tCASE \n\t\t\t\t\tWHEN L9.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\tTHEN L9.[HIERARCHYNODE]\n\t\t\t\t\tWHEN L8.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\tTHEN L8.[HIERARCHYNODE]\n\t\t\t\t\tWHEN L7.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\tTHEN L7.[HIERARCHYNODE]\n\t\t\t\t\tWHEN L6.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\tTHEN L6.[HIERARCHYNODE]\n\t\t\t\t\tWHEN L5.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\tTHEN L5.[HIERARCHYNODE]\n\t\t\t\t\tWHEN L4.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\tTHEN L4.[HIERARCHYNODE]\n\t\t\t\t\tWHEN L3.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\tTHEN L3.[HIERARCHYNODE]\n\t\t\t\t\tWHEN L2.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\tTHEN L2.[HIERARCHYNODE]\n\t\t\t\t\tWHEN L1.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\tTHEN L1.[HIERARCHYNODE]\n\t\t\t\t\tEND\n\t\t\t\t) AS CHILD\n\t\t\t,(\n\t\t\t\tCASE \n\t\t\t\t\tWHEN L9.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\tTHEN L9.[PARENTNODE]\n\t\t\t\t\tWHEN L8.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\tTHEN L8.[PARENTNODE]\n\t\t\t\t\tWHEN L7.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\tTHEN L7.[PARENTNODE]\n\t\t\t\t\tWHEN L6.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\tTHEN L6.[PARENTNODE]\n\t\t\t\t\tWHEN L5.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\tTHEN L5.[PARENTNODE]\n\t\t\t\t\tWHEN L4.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\tTHEN L4.[PARENTNODE]\n\t\t\t\t\tWHEN L3.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\tTHEN L3.[PARENTNODE]\n\t\t\t\t\tWHEN L2.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\tTHEN L2.[PARENTNODE]\n\t\t\t\t\tWHEN L1.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\tTHEN L1.[PARENTNODE]\n\t\t\t\t\tEND\n\t\t\t\t) AS PARENT\n\t\t/*\t,CONCAT (\n\t\t\t\tL1.CONTROLLINGAREA\n\t\t\t\t,'|'*/\n\t\t\t\t,(\n\t\t\t\t\tCASE \n\t\t\t\t\t\tWHEN L9.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\t\tTHEN L9.[Key] -- L9.[HIERARCHYNODEVAL]\n\t\t\t\t\t\tWHEN L8.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\t\tTHEN L8.[Key] -- L8.[HIERARCHYNODEVAL]\n\t\t\t\t\t\tWHEN L7.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\t\tTHEN L7.[Key] -- L7.[HIERARCHYNODEVAL]\n\t\t\t\t\t\tWHEN L6.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\t\tTHEN L6.[Key] -- L6.[HIERARCHYNODEVAL]\n\t\t\t\t\t\tWHEN L5.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\t\tTHEN L5.[Key] -- L5.[HIERARCHYNODEVAL]\n\t\t\t\t\t\tWHEN L4.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\t\tTHEN L4.[Key] -- L4.[HIERARCHYNODEVAL]\n\t\t\t\t\t\tWHEN L3.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\t\tTHEN L3.[Key] -- L3.[HIERARCHYNODEVAL]\n\t\t\t\t\t\tWHEN L2.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\t\tTHEN L2.[Key] -- L2.[HIERARCHYNODEVAL]\n\t\t\t\t\t\tWHEN L1.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\t\tTHEN L1.[Key] -- L1.[HIERARCHYNODEVAL]\n\t\t\t\t\t\tEND\n\t\t\t\t\t)\n\t\t\t\t--) \n                AS [COST_CENTER_NODE_KEY]\n\t\t\t,L1.[HIERARCHYNODEVAL] AS LEVEL1\n            ,L1.[Key]  AS LEVEL1_KEY\n--\t\t\t,NULLIF(CONCAT_WS('|', COALESCE(L1.[CONTROLLINGAREA], NULL), COALESCE(L1.[HIERARCHYNODE], NULL)), '') AS LEVEL1_KEY\n\t\t\t,L2.[HIERARCHYNODEVAL] AS LEVEL2\n            ,L2.[Key]  AS LEVEL2_KEY\n--\t\t\t,NULLIF(CONCAT_WS('|', COALESCE(L2.[CONTROLLINGAREA], NULL), COALESCE(L2.[HIERARCHYNODE], NULL)), '') AS LEVEL2_KEY\n\t\t\t,L3.[HIERARCHYNODEVAL] AS LEVEL3\n            ,L3.[Key]  AS LEVEL3_KEY\n--\t\t\t,NULLIF(CONCAT_WS('|', COALESCE(L3.[CONTROLLINGAREA], NULL), COALESCE(L3.[HIERARCHYNODE], NULL)), '') AS LEVEL3_KEY\n\t\t\t,L4.[HIERARCHYNODEVAL] AS LEVEL4\n            ,L4.[Key]  AS LEVEL4_KEY\n--\t\t\t,NULLIF(CONCAT_WS('|', COALESCE(L4.[CONTROLLINGAREA], NULL), COALESCE(L4.[HIERARCHYNODE], NULL)), '') AS LEVEL4_KEY\n\t\t\t,L5.[HIERARCHYNODEVAL] AS LEVEL5\n            ,L5.[Key]  AS LEVEL5_KEY\n--\t\t\t,NULLIF(CONCAT_WS('|', COALESCE(L5.[CONTROLLINGAREA], NULL), COALESCE(L5.[HIERARCHYNODE], NULL)), '') AS LEVEL5_KEY\n\t\t\t,L6.[HIERARCHYNODEVAL] AS LEVEL6\n            ,L6.[Key]  AS LEVEL6_KEY\n--\t\t\t,NULLIF(CONCAT_WS('|', COALESCE(L6.[CONTROLLINGAREA], NULL), COALESCE(L6.[HIERARCHYNODE], NULL)), '') AS LEVEL6_KEY\n\t\t\t,L7.[HIERARCHYNODEVAL] AS LEVEL7\n            ,L7.[Key]  AS LEVEL7_KEY\n--\t\t\t,NULLIF(CONCAT_WS('|', COALESCE(L7.[CONTROLLINGAREA], NULL), COALESCE(L7.[HIERARCHYNODE], NULL)), '') AS LEVEL7_KEY\n\t\t\t,L8.[HIERARCHYNODEVAL] AS LEVEL8\n            ,L8.[Key]  AS LEVEL8_KEY\n--\t\t\t,NULLIF(CONCAT_WS('|', COALESCE(L8.[CONTROLLINGAREA], NULL), COALESCE(L8.[HIERARCHYNODE], NULL)), '') AS LEVEL8_KEY\n\t\t\t,L9.[HIERARCHYNODEVAL] AS LEVEL9\n            ,L9.[Key]  AS LEVEL9_KEY\n--\t\t\t,NULLIF(CONCAT_WS('|', COALESCE(L9.[CONTROLLINGAREA], NULL), COALESCE(L9.[HIERARCHYNODE], NULL)), '') AS LEVEL9_KEY\n\t\t\t,CONCAT_WS('|', L1.[HIERARCHYNODEVAL], L2.[HIERARCHYNODEVAL], L3.[HIERARCHYNODEVAL], L4.[HIERARCHYNODEVAL], L5.[HIERARCHYNODEVAL], L6.[HIERARCHYNODEVAL], L7.[HIERARCHYNODEVAL], L8.[HIERARCHYNODEVAL], L9.[HIERARCHYNODEVAL]) AS HierarchyPath \n\t\t\t-- [TL]: Added to determine MAX Hierarchy Level \n            , LEN(CONCAT_WS ('|' ,L1.[HIERARCHYNODEVAL] ,L2.[HIERARCHYNODEVAL] ,L3.[HIERARCHYNODEVAL] ,L4.[HIERARCHYNODEVAL] ,L5.[HIERARCHYNODEVAL] ,L6.[HIERARCHYNODEVAL] ,L7.[HIERARCHYNODEVAL] ,L8.[HIERARCHYNODEVAL] ,L9.[HIERARCHYNODEVAL] )) - LEN(REPLACE(CONCAT_WS ('|' ,L1.[HIERARCHYNODEVAL] ,L2.[HIERARCHYNODEVAL] ,L3.[HIERARCHYNODEVAL] ,L4.[HIERARCHYNODEVAL] ,L5.[HIERARCHYNODEVAL] ,L6.[HIERARCHYNODEVAL] ,L7.[HIERARCHYNODEVAL] ,L8.[HIERARCHYNODEVAL] ,L9.[HIERARCHYNODEVAL] ), '|', '')) + 1 AS MaxHierarchyLevel \n            FROM FHN L1 LEFT OUTER JOIN FHN L2 ON L1.[COSTCENTERHIERARCHY] = L2.[COSTCENTERHIERARCHY] AND L1.[HIERARCHYNODE] = L2.[PARENTNODE] \n            LEFT OUTER JOIN FHN L3 ON L2.[COSTCENTERHIERARCHY] = L3.[COSTCENTERHIERARCHY] AND L2.[HIERARCHYNODE] = L3.[PARENTNODE] \n            LEFT OUTER JOIN FHN L4 ON L3.[COSTCENTERHIERARCHY] = L4.[COSTCENTERHIERARCHY] AND L3.[HIERARCHYNODE] = L4.[PARENTNODE] \n            LEFT OUTER JOIN FHN L5 ON L4.[COSTCENTERHIERARCHY] = L5.[COSTCENTERHIERARCHY] AND L4.[HIERARCHYNODE] = L5.[PARENTNODE] \n            LEFT OUTER JOIN FHN L6 ON L5.[COSTCENTERHIERARCHY] = L6.[COSTCENTERHIERARCHY] AND L5.[HIERARCHYNODE] = L6.[PARENTNODE] \n            LEFT OUTER JOIN FHN L7 ON L6.[COSTCENTERHIERARCHY] = L7.[COSTCENTERHIERARCHY] AND L6.[HIERARCHYNODE] = L7.[PARENTNODE] \n            LEFT OUTER JOIN FHN L8 ON L7.[COSTCENTERHIERARCHY] = L8.[COSTCENTERHIERARCHY] AND L7.[HIERARCHYNODE] = L8.[PARENTNODE] \n            LEFT OUTER JOIN FHN L9 ON L8.[COSTCENTERHIERARCHY] = L9.[COSTCENTERHIERARCHY] AND L8.[HIERARCHYNODE] = L9.[PARENTNODE] \n            --WHERE L1.hierarchynodeval= '0001' \n            )\n            /* UNION ALL SELECT L0. [COSTCENTERHIERARCHY], L0.[controllingarea] AS [Controllingarea], L0.[hierarchynode] AS CHILD, L0.[parentnode] AS PARENT, Concat(L0.[controllingarea], '|', L0.[hierarchynodeval]) AS [COST_CENTER_NODE_KEY], L0.[hierarchynode] AS LEVEL1, Concat(COALESCE(L0.[controllingarea], ''), '|', COALESCE(L0.[hierarchynode], '')) AS LEVEL1_KEY, ' ' AS LEVEL2, ' ' AS LEVEL2_KEY, ' ' AS LEVEL3, ' ' AS LEVEL3_KEY, ' ' AS LEVEL4, ' ' AS LEVEL4_KEY, ' ' AS LEVEL5, ' ' AS LEVEL5_KEY, ' ' AS LEVEL6, ' ' AS LEVEL6_KEY, ' ' AS LEVEL7, ' ' AS LEVEL7_KEY, ' ' AS LEVEL8, ' ' AS LEVEL8_KEY, ' ' AS LEVEL9, ' ' AS LEVEL9_KEY, L0.[hierarchynode] AS HierarchyPath ,1 as MaxHierarchyLevel FROM [sap_master].[i_costcenterhierarchynode] L0 WHERE L0.[validityenddate] = '99991231' AND L0.parentnode = ' ' */\n\t\t\n\t\t",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "sap_gold",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}