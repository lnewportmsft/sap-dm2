{
	"name": "COSTCENTERHIERARCHY",
	"properties": {
		"folder": {
			"name": "Hierarchy_View_Scripts"
		},
		"content": {
			"query": "SET ANSI_NULLS ON\nGO\nSET QUOTED_IDENTIFIER ON\nGO\n\nCREATE VIEW [dmgold].[COSTCENTERHIERARCHY]\nAS WITH FHN (\n\t[COSTCENTERHIERARCHY]\n\t,[PARENTNODE]\n\t,[HIERARCHYNODE]\n\t,[Controllingarea]\n\t,[HIERARCHYNODEVAL]\n\t,[Nodetype]\n\t,[costcenter]\n\t,VALIDITYENDDATE,VALIDITYSTARTDATE,[_SystemName]\n    ,[Key]\n\t)\nAS (\n\tSELECT H.[COSTCENTERHIERARCHY]\n\t\t,H.[PARENTNODE]\n\t\t,H.[HIERARCHYNODE]\n\t\t,H.[Controllingarea]\n\t\t,H.[HIERARCHYNODEVAL]\n\t\t,H.[Nodetype]\n\t\t,H.[costcenter]\n\t\t,H.VALIDITYENDDATE,H.VALIDITYSTARTDATE,[_SystemName]\n        ,H.[Key]\n\tFROM [dmgold].[I_COSTCENTERHIERARCHYNODE] H\n\tWHERE H.[VALIDITYENDDATE] = '99991231'\n\tGROUP BY H.[COSTcenterHIERARCHY]\n\t\t,H.[PARENTNODE]\n\t\t,H.[HIERARCHYNODE]\n\t\t,H.[Controllingarea]\n\t\t,H.[HIERARCHYNODEVAL]\n\t\t,H.[Nodetype]\n\t\t,H.[costcenter]\n\t\t,H.VALIDITYENDDATE,H.VALIDITYSTARTDATE,[_SystemName]\n        ,H.[Key]\n\t) (\n\t\tSELECT L1.[COSTcenterHIERARCHY]\n\t\t\t,L1.[Controllingarea]\n\t\t\t,(\n\t\t\t\tCASE \n\t\t\t\t\tWHEN L9.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\tTHEN L9.[HIERARCHYNODE]\n\t\t\t\t\tWHEN L8.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\tTHEN L8.[HIERARCHYNODE]\n\t\t\t\t\tWHEN L7.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\tTHEN L7.[HIERARCHYNODE]\n\t\t\t\t\tWHEN L6.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\tTHEN L6.[HIERARCHYNODE]\n\t\t\t\t\tWHEN L5.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\tTHEN L5.[HIERARCHYNODE]\n\t\t\t\t\tWHEN L4.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\tTHEN L4.[HIERARCHYNODE]\n\t\t\t\t\tWHEN L3.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\tTHEN L3.[HIERARCHYNODE]\n\t\t\t\t\tWHEN L2.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\tTHEN L2.[HIERARCHYNODE]\n\t\t\t\t\tWHEN L1.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\tTHEN L1.[HIERARCHYNODE]\n\t\t\t\t\tEND\n\t\t\t\t) AS CHILD\n\t\t\t,(\n\t\t\t\tCASE \n\t\t\t\t\tWHEN L9.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\tTHEN L9.[PARENTNODE]\n\t\t\t\t\tWHEN L8.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\tTHEN L8.[PARENTNODE]\n\t\t\t\t\tWHEN L7.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\tTHEN L7.[PARENTNODE]\n\t\t\t\t\tWHEN L6.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\tTHEN L6.[PARENTNODE]\n\t\t\t\t\tWHEN L5.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\tTHEN L5.[PARENTNODE]\n\t\t\t\t\tWHEN L4.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\tTHEN L4.[PARENTNODE]\n\t\t\t\t\tWHEN L3.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\tTHEN L3.[PARENTNODE]\n\t\t\t\t\tWHEN L2.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\tTHEN L2.[PARENTNODE]\n\t\t\t\t\tWHEN L1.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\tTHEN L1.[PARENTNODE]\n\t\t\t\t\tEND\n\t\t\t\t) AS PARENT\n\t\t/*\t,CONCAT (\n\t\t\t\tL1.CONTROLLINGAREA\n\t\t\t\t,'|'*/\n\t\t\t\t,(\n\t\t\t\t\tCASE \n\t\t\t\t\t\tWHEN l9.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\t\tTHEN l9.[VALIDITYENDDATE] -- l9.[hierarchynodeval]\n\t\t\t\t\t\tWHEN l8.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\t\tTHEN l8.[VALIDITYENDDATE] -- l8.[hierarchynodeval]\n\t\t\t\t\t\tWHEN l7.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\t\tTHEN l7.[VALIDITYENDDATE] -- l7.[hierarchynodeval]\n\t\t\t\t\t\tWHEN l6.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\t\tTHEN l6.[VALIDITYENDDATE] -- l6.[hierarchynodeval]\n\t\t\t\t\t\tWHEN l5.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\t\tTHEN l5.[VALIDITYENDDATE] -- l5.[hierarchynodeval]\n\t\t\t\t\t\tWHEN l4.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\t\tTHEN l4.[VALIDITYENDDATE] -- l4.[hierarchynodeval]\n\t\t\t\t\t\tWHEN l3.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\t\tTHEN l3.[VALIDITYENDDATE] -- l3.[hierarchynodeval]\n\t\t\t\t\t\tWHEN l2.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\t\tTHEN l2.[VALIDITYENDDATE] -- l2.[hierarchynodeval]\n\t\t\t\t\t\tWHEN l1.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\t\tTHEN l1.[VALIDITYENDDATE] -- l1.[hierarchynodeval]\n\t\t\t\t\t\tEND\n\t\t\t\t\t)\n\t\t\t\t--)\n                 AS [VALIDITYENDDATE]\n\t\t\t\t ,(\n\t\t\t\t\tCASE \n\t\t\t\t\t\tWHEN l9.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\t\tTHEN l9.[VALIDITYSTARTDATE] -- l9.[hierarchynodeval]\n\t\t\t\t\t\tWHEN l8.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\t\tTHEN l8.[VALIDITYSTARTDATE] -- l8.[hierarchynodeval]\n\t\t\t\t\t\tWHEN l7.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\t\tTHEN l7.[VALIDITYSTARTDATE] -- l7.[hierarchynodeval]\n\t\t\t\t\t\tWHEN l6.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\t\tTHEN l6.[VALIDITYSTARTDATE] -- l6.[hierarchynodeval]\n\t\t\t\t\t\tWHEN l5.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\t\tTHEN l5.[VALIDITYSTARTDATE] -- l5.[hierarchynodeval]\n\t\t\t\t\t\tWHEN l4.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\t\tTHEN l4.[VALIDITYSTARTDATE] -- l4.[hierarchynodeval]\n\t\t\t\t\t\tWHEN l3.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\t\tTHEN l3.[VALIDITYSTARTDATE] -- l3.[hierarchynodeval]\n\t\t\t\t\t\tWHEN l2.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\t\tTHEN l2.[VALIDITYSTARTDATE] -- l2.[hierarchynodeval]\n\t\t\t\t\t\tWHEN l1.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\t\tTHEN l1.[VALIDITYSTARTDATE] -- l1.[hierarchynodeval]\n\t\t\t\t\t\tEND\n\t\t\t\t\t)\n\t\t\t\t--)\n                 AS [VALIDITYSTARTDATE]\n\t\t\t\t \t ,(\n\t\t\t\t\tCASE \n\t\t\t\t\t\tWHEN l9.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\t\tTHEN l9.[costcenter] -- l9.[hierarchynodeval]\n\t\t\t\t\t\tWHEN l8.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\t\tTHEN l8.[costcenter] -- l8.[hierarchynodeval]\n\t\t\t\t\t\tWHEN l7.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\t\tTHEN l7.[costcenter] -- l7.[hierarchynodeval]\n\t\t\t\t\t\tWHEN l6.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\t\tTHEN l6.[costcenter] -- l6.[hierarchynodeval]\n\t\t\t\t\t\tWHEN l5.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\t\tTHEN l5.[costcenter] -- l5.[hierarchynodeval]\n\t\t\t\t\t\tWHEN l4.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\t\tTHEN l4.[costcenter] -- l4.[hierarchynodeval]\n\t\t\t\t\t\tWHEN l3.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\t\tTHEN l3.[costcenter] -- l3.[hierarchynodeval]\n\t\t\t\t\t\tWHEN l2.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\t\tTHEN l2.[costcenter] -- l2.[hierarchynodeval]\n\t\t\t\t\t\tWHEN l1.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\t\tTHEN l1.[costcenter] -- l1.[hierarchynodeval]\n\t\t\t\t\t\tEND\n\t\t\t\t\t)\n\t\t\t\t--)\n                 AS [CostCenter]\n/*\t\t\t\t,(\n\t\t\t\t\tCASE \n\t\t\t\t\t\tWHEN L9.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\t\tTHEN L9.[Key] -- L9.[HIERARCHYNODEVAL]\n\t\t\t\t\t\tWHEN L8.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\t\tTHEN L8.[Key] -- L8.[HIERARCHYNODEVAL]\n\t\t\t\t\t\tWHEN L7.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\t\tTHEN L7.[Key] -- L7.[HIERARCHYNODEVAL]\n\t\t\t\t\t\tWHEN L6.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\t\tTHEN L6.[Key] -- L6.[HIERARCHYNODEVAL]\n\t\t\t\t\t\tWHEN L5.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\t\tTHEN L5.[Key] -- L5.[HIERARCHYNODEVAL]\n\t\t\t\t\t\tWHEN L4.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\t\tTHEN L4.[Key] -- L4.[HIERARCHYNODEVAL]\n\t\t\t\t\t\tWHEN L3.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\t\tTHEN L3.[Key] -- L3.[HIERARCHYNODEVAL]\n\t\t\t\t\t\tWHEN L2.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\t\tTHEN L2.[Key] -- L2.[HIERARCHYNODEVAL]\n\t\t\t\t\t\tWHEN L1.[HIERARCHYNODEVAL] IS NOT NULL\n\t\t\t\t\t\t\tTHEN L1.[Key] -- L1.[HIERARCHYNODEVAL]\n\t\t\t\t\t\tEND\n\t\t\t\t\t)\n\t\t\t\t--) \n                AS [COST_CENTER_NODE_KEY] */\n\t\t\t\t,nullif(l1.[hierarchynodeval],NULL) AS level1\n\t\t\t,nullif(l1.[key],NULL) AS level1_key\n            --,nullif(concat_ws('|', coalesce(l1.[controllingarea], NULL), coalesce(l1.[hierarchynode], NULL)), '') AS level1_key\n\t\t\t,nullif(l2.[hierarchynodeval],NULL) AS level2\n\t\t\t,nullif(l2.[key],NULL) AS level2_key\n            --,nullif(concat_ws('|', coalesce(l2.[controllingarea], NULL), coalesce(l2.[hierarchynode], NULL)), '') AS level2_key\n\t\t\t,nullif(l3.[hierarchynodeval],NULL) AS level3\n\t\t\t,nullif(l3.[key],NULL) AS level3_key\n            --,nullif(concat_ws('|', coalesce(l3.[controllingarea], NULL), coalesce(l3.[hierarchynode], NULL)), '') AS level3_key\n\t\t\t,nullif(l4.[hierarchynodeval],NULL) AS level4\n\t\t\t,nullif(l4.[key],NULL) AS level4_key\n            --,nullif(concat_ws('|', coalesce(l4.[controllingarea], NULL), coalesce(l4.[hierarchynode], NULL)), '') AS level4_key\n\t\t\t,nullif(l5.[hierarchynodeval],NULL) AS level5\n\t\t\t,nullif(l5.[key],NULL) AS level5_key\n            --,nullif(concat_ws('|', coalesce(l5.[controllingarea], NULL), coalesce(l5.[hierarchynode], NULL)), '') AS level5_key\n\t\t\t,nullif(l6.[hierarchynodeval],NULL) AS level6\n\t\t\t,nullif(l6.[key],NULL) AS level6_key\n            --,nullif(concat_ws('|', coalesce(l6.[controllingarea], NULL), coalesce(l6.[hierarchynode], NULL)), '') AS level6_key\n\t\t\t,nullif(l7.[hierarchynodeval],NULL) AS level7\n\t\t\t,nullif(l7.[key],NULL) AS level7_key\n            --,nullif(concat_ws('|', coalesce(l7.[controllingarea], NULL), coalesce(l7.[hierarchynode], NULL)), '') AS level7_key\n\t\t\t,nullif(l8.[hierarchynodeval],NULL) AS level8\n\t\t\t,nullif(l8.[key],NULL) AS level8_key\n            --,nullif(concat_ws('|', coalesce(l8.[controllingarea], NULL), coalesce(l8.[hierarchynode], NULL)), '') AS level8_key\n\t\t\t,nullif(l9.[hierarchynodeval],NULL) AS level9\n\t\t\t,nullif(l9.[key],NULL) AS level9_key\n--\t\t\t,NULLIF(CONCAT_WS('|', COALESCE(L9.[CONTROLLINGAREA], NULL), COALESCE(L9.[HIERARCHYNODE], NULL)), '') AS LEVEL9_KEY\n\t\t\t,CONCAT_WS('|', L1.[HIERARCHYNODEVAL], L2.[HIERARCHYNODEVAL], L3.[HIERARCHYNODEVAL], L4.[HIERARCHYNODEVAL], L5.[HIERARCHYNODEVAL], L6.[HIERARCHYNODEVAL], L7.[HIERARCHYNODEVAL], L8.[HIERARCHYNODEVAL], L9.[HIERARCHYNODEVAL]) AS HierarchyPath \n\t\t\t-- [TL]: Added to determine MAX Hierarchy Level \n            , LEN(CONCAT_WS ('|' ,L1.[HIERARCHYNODEVAL] ,L2.[HIERARCHYNODEVAL] ,L3.[HIERARCHYNODEVAL] ,L4.[HIERARCHYNODEVAL] ,L5.[HIERARCHYNODEVAL] ,L6.[HIERARCHYNODEVAL] ,L7.[HIERARCHYNODEVAL] ,L8.[HIERARCHYNODEVAL] ,L9.[HIERARCHYNODEVAL] )) - LEN(REPLACE(CONCAT_WS ('|' ,L1.[HIERARCHYNODEVAL] ,L2.[HIERARCHYNODEVAL] ,L3.[HIERARCHYNODEVAL] ,L4.[HIERARCHYNODEVAL] ,L5.[HIERARCHYNODEVAL] ,L6.[HIERARCHYNODEVAL] ,L7.[HIERARCHYNODEVAL] ,L8.[HIERARCHYNODEVAL] ,L9.[HIERARCHYNODEVAL] ), '|', '')) + 1 AS MaxHierarchyLevel \n            ,L1.[_SystemName]\n\t\t\tFROM FHN L1 LEFT OUTER JOIN FHN L2 ON L1.[COSTCENTERHIERARCHY] = L2.[COSTCENTERHIERARCHY] AND L1.[HIERARCHYNODE] = L2.[PARENTNODE] \n            LEFT OUTER JOIN FHN L3 ON L2.[COSTCENTERHIERARCHY] = L3.[COSTCENTERHIERARCHY] AND L2.[HIERARCHYNODE] = L3.[PARENTNODE] \n            LEFT OUTER JOIN FHN L4 ON L3.[COSTCENTERHIERARCHY] = L4.[COSTCENTERHIERARCHY] AND L3.[HIERARCHYNODE] = L4.[PARENTNODE] \n            LEFT OUTER JOIN FHN L5 ON L4.[COSTCENTERHIERARCHY] = L5.[COSTCENTERHIERARCHY] AND L4.[HIERARCHYNODE] = L5.[PARENTNODE] \n            LEFT OUTER JOIN FHN L6 ON L5.[COSTCENTERHIERARCHY] = L6.[COSTCENTERHIERARCHY] AND L5.[HIERARCHYNODE] = L6.[PARENTNODE] \n            LEFT OUTER JOIN FHN L7 ON L6.[COSTCENTERHIERARCHY] = L7.[COSTCENTERHIERARCHY] AND L6.[HIERARCHYNODE] = L7.[PARENTNODE] \n            LEFT OUTER JOIN FHN L8 ON L7.[COSTCENTERHIERARCHY] = L8.[COSTCENTERHIERARCHY] AND L7.[HIERARCHYNODE] = L8.[PARENTNODE] \n            LEFT OUTER JOIN FHN L9 ON L8.[COSTCENTERHIERARCHY] = L9.[COSTCENTERHIERARCHY] AND L8.[HIERARCHYNODE] = L9.[PARENTNODE] \n\t\t\tWHERE L1.nodetype = 'R'\n            );\nGO",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "sapdmsqlpool",
				"poolName": "sapdmsqlpool"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}