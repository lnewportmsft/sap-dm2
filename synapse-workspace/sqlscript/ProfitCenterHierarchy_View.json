{
	"name": "ProfitCenterHierarchy_View",
	"properties": {
		"content": {
			"query": "\nCREATE VIEW [sap_master].[ProfitCenterHierarchy] AS\nWITH fhn (\n\t[profitcenterhierarchy]\n\t,[parentnode]\n\t,[hierarchynode]\n\t,[controllingarea]\n\t,[hierarchynodeval]\n\t,[nodetype]\n    ,[key]\n\t)\nAS (\n\tSELECT h.[profitcenterhierarchy]\n\t\t,h.[parentnode           ]\n\t\t,h.[hierarchynode        ]\n\t\t,h.[controllingarea      ]\n\t\t,h.[hierarchynodeval     ]\n\t\t,h.[nodetype             ]\n        ,h.[key]\n\tFROM [sap_master].[i_profitcenterhierarchynode] h\n\tWHERE h.[validityenddate] = '99991231'\n\tGROUP BY h.[profitcenterhierarchy]\n\t\t,h.[parentnode]\n\t\t,h.[hierarchynode]\n\t\t,h.[controllingarea]\n\t\t,h.[hierarchynodeval]\n\t\t,h.[nodetype]\n        ,h.[key]\n\t) (\n\t\tSELECT l1.[profitcenterhierarchy]\n\t\t\t,l1.[controllingarea      ]\n\t\t\t,(\n\t\t\t\tCASE \n\t\t\t\t\tWHEN l9.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\tTHEN l9.[hierarchynode]\n\t\t\t\t\tWHEN l8.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\tTHEN l8.[hierarchynode]\n\t\t\t\t\tWHEN l7.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\tTHEN l7.[hierarchynode]\n\t\t\t\t\tWHEN l6.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\tTHEN l6.[hierarchynode]\n\t\t\t\t\tWHEN l5.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\tTHEN l5.[hierarchynode]\n\t\t\t\t\tWHEN l4.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\tTHEN l4.[hierarchynode]\n\t\t\t\t\tWHEN l3.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\tTHEN l3.[hierarchynode]\n\t\t\t\t\tWHEN l2.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\tTHEN l2.[hierarchynode]\n\t\t\t\t\tWHEN l1.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\tTHEN l1.[hierarchynode]\n\t\t\t\t\tEND\n\t\t\t\t) AS child\n\t\t\t,(\n\t\t\t\tCASE \n\t\t\t\t\tWHEN l9.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\tTHEN l9.[parentnode]\n\t\t\t\t\tWHEN l8.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\tTHEN l8.[parentnode]\n\t\t\t\t\tWHEN l7.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\tTHEN l7.[parentnode]\n\t\t\t\t\tWHEN l6.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\tTHEN l6.[parentnode]\n\t\t\t\t\tWHEN l5.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\tTHEN l5.[parentnode]\n\t\t\t\t\tWHEN l4.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\tTHEN l4.[parentnode]\n\t\t\t\t\tWHEN l3.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\tTHEN l3.[parentnode]\n\t\t\t\t\tWHEN l2.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\tTHEN l2.[parentnode]\n\t\t\t\t\tWHEN l1.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\tTHEN l1.[parentnode]\n\t\t\t\t\tEND\n\t\t\t\t) AS parent\n\t\t\t,/*CONCAT (\n\t\t\t\tl1.controllingarea\n\t\t\t\t,'|'\n\t\t\t\t,*/(\n\t\t\t\t\tCASE \n\t\t\t\t\t\tWHEN l9.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\t\tTHEN l9.[key] -- l9.[hierarchynodeval]\n\t\t\t\t\t\tWHEN l8.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\t\tTHEN l8.[key] -- l8.[hierarchynodeval]\n\t\t\t\t\t\tWHEN l7.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\t\tTHEN l7.[key] -- l7.[hierarchynodeval]\n\t\t\t\t\t\tWHEN l6.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\t\tTHEN l6.[key] -- l6.[hierarchynodeval]\n\t\t\t\t\t\tWHEN l5.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\t\tTHEN l5.[key] -- l5.[hierarchynodeval]\n\t\t\t\t\t\tWHEN l4.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\t\tTHEN l4.[key] -- l4.[hierarchynodeval]\n\t\t\t\t\t\tWHEN l3.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\t\tTHEN l3.[key] -- l3.[hierarchynodeval]\n\t\t\t\t\t\tWHEN l2.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\t\tTHEN l2.[key] -- l2.[hierarchynodeval]\n\t\t\t\t\t\tWHEN l1.[hierarchynodeval] IS NOT NULL\n\t\t\t\t\t\t\tTHEN l1.[key] -- l1.[hierarchynodeval]\n\t\t\t\t\t\tEND\n\t\t\t\t\t)\n\t\t\t\t--)\n                 AS [profit_center_node_key]\n\t\t\t,l1.[hierarchynodeval] AS level1\n\t\t\t,l1.[key] AS level1_key\n            --,nullif(concat_ws('|', coalesce(l1.[controllingarea], NULL), coalesce(l1.[hierarchynode], NULL)), '') AS level1_key\n\t\t\t,l2.[hierarchynodeval] AS level2\n\t\t\t,l2.[key] AS level2_key\n            --,nullif(concat_ws('|', coalesce(l2.[controllingarea], NULL), coalesce(l2.[hierarchynode], NULL)), '') AS level2_key\n\t\t\t,l3.[hierarchynodeval] AS level3\n\t\t\t,l3.[key] AS level3_key\n            --,nullif(concat_ws('|', coalesce(l3.[controllingarea], NULL), coalesce(l3.[hierarchynode], NULL)), '') AS level3_key\n\t\t\t,l4.[hierarchynodeval] AS level4\n\t\t\t,l4.[key] AS level4_key\n            --,nullif(concat_ws('|', coalesce(l4.[controllingarea], NULL), coalesce(l4.[hierarchynode], NULL)), '') AS level4_key\n\t\t\t,l5.[hierarchynodeval] AS level5\n\t\t\t,l5.[key] AS level5_key\n            --,nullif(concat_ws('|', coalesce(l5.[controllingarea], NULL), coalesce(l5.[hierarchynode], NULL)), '') AS level5_key\n\t\t\t,l6.[hierarchynodeval] AS level6\n\t\t\t,l6.[key] AS level6_key\n            --,nullif(concat_ws('|', coalesce(l6.[controllingarea], NULL), coalesce(l6.[hierarchynode], NULL)), '') AS level6_key\n\t\t\t,l7.[hierarchynodeval] AS level7\n\t\t\t,l7.[key] AS level7_key\n            --,nullif(concat_ws('|', coalesce(l7.[controllingarea], NULL), coalesce(l7.[hierarchynode], NULL)), '') AS level7_key\n\t\t\t,l8.[hierarchynodeval] AS level8\n\t\t\t,l8.[key] AS level8_key\n            --,nullif(concat_ws('|', coalesce(l8.[controllingarea], NULL), coalesce(l8.[hierarchynode], NULL)), '') AS level8_key\n\t\t\t,l9.[hierarchynodeval] AS level9\n\t\t\t,l9.[key] AS level9_key\n            --,nullif(concat_ws('|', coalesce(l9.[controllingarea], NULL), coalesce(l9.[hierarchynode], NULL)), '') AS level9_key\n\t\t\t,concat_ws('|', l1.[hierarchynodeval], l2.[hierarchynodeval], l3.[hierarchynodeval], l4.[hierarchynodeval], l5.[hierarchynodeval], l6.[hierarchynodeval], l7.[hierarchynodeval], l8.[hierarchynodeval], l9.[hierarchynodeval]) AS hierarchypath\n\t\t\t-- [TL]: Added to determine MAX Hierarchy Level \n            , LEN(CONCAT_WS ('|' ,L1.[HIERARCHYNODEVAL] ,L2.[HIERARCHYNODEVAL] ,L3.[HIERARCHYNODEVAL] ,L4.[HIERARCHYNODEVAL] ,L5.[HIERARCHYNODEVAL] ,L6.[HIERARCHYNODEVAL] ,L7.[HIERARCHYNODEVAL] ,L8.[HIERARCHYNODEVAL] ,L9.[HIERARCHYNODEVAL] )) - LEN(REPLACE(CONCAT_WS ('|' ,L1.[HIERARCHYNODEVAL] ,L2.[HIERARCHYNODEVAL] ,L3.[HIERARCHYNODEVAL] ,L4.[HIERARCHYNODEVAL] ,L5.[HIERARCHYNODEVAL] ,L6.[HIERARCHYNODEVAL] ,L7.[HIERARCHYNODEVAL] ,L8.[HIERARCHYNODEVAL] ,L9.[HIERARCHYNODEVAL] ), '|', '')) + 1 AS MaxHierarchyLevel \n            FROM FHN L1 LEFT OUTER JOIN FHN L2 ON \n            L1.[PROFITCENTERHIERARCHY] = L2.[PROFITCENTERHIERARCHY] AND L1.[HIERARCHYNODE] = L2.[PARENTNODE] \n            LEFT OUTER JOIN FHN L3 ON L2.[PROFITCENTERHIERARCHY] = L3.[PROFITCENTERHIERARCHY] AND L2.[HIERARCHYNODE] = L3.[PARENTNODE] \n            LEFT OUTER JOIN FHN L4 ON L3.[PROFITCENTERHIERARCHY] = L4.[PROFITCENTERHIERARCHY] AND L3.[HIERARCHYNODE] = L4.[PARENTNODE] \n            LEFT OUTER JOIN FHN L5 ON L4.[PROFITCENTERHIERARCHY] = L5.[PROFITCENTERHIERARCHY] AND L4.[HIERARCHYNODE] = L5.[PARENTNODE] \n            LEFT OUTER JOIN FHN L6 ON L5.[PROFITCENTERHIERARCHY] = L6.[PROFITCENTERHIERARCHY] AND L5.[HIERARCHYNODE] = L6.[PARENTNODE] \n            LEFT OUTER JOIN FHN L7 ON L6.[PROFITCENTERHIERARCHY] = L7.[PROFITCENTERHIERARCHY] AND L6.[HIERARCHYNODE] = L7.[PARENTNODE] \n            LEFT OUTER JOIN FHN L8 ON L7.[PROFITCENTERHIERARCHY] = L8.[PROFITCENTERHIERARCHY] AND L7.[HIERARCHYNODE] = L8.[PARENTNODE] \n            LEFT OUTER JOIN FHN L9 ON L8.[PROFITCENTERHIERARCHY] = L9.[PROFITCENTERHIERARCHY] AND L8.[HIERARCHYNODE] = L9.[PARENTNODE] \n            --WHERE L1.hierarchynodeval= 'YBPH' --'ZUS10_P_CL' )\n\t\t)",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "sap_gold",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}